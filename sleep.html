<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>劍橋博士睡眠追蹤中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .loading-overlay { background: rgba(255,255,255,0.8); position: fixed; inset: 0; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .admin-only { display: none; } /* 預設完全不佔空間 */
        .status-badge { padding: 2px 8px; border-radius: 99px; font-size: 12px; font-weight: 500; }
        .scroll-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen">

<div id="loader" class="loading-overlay">
    <div class="flex flex-col items-center">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-indigo-600"></i>
        <p class="mt-4 text-gray-600 font-medium">數據讀取中...</p>
    </div>
</div>

<nav class="bg-white border-b sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                <i class="fa-solid fa-moon"></i>
            </div>
            <span class="font-bold text-xl tracking-tight">睡眠追蹤中心</span>
        </div>
        <div id="user-display" class="text-sm font-medium text-gray-500"></div>
    </div>
</nav>

<main class="max-w-6xl mx-auto px-4 py-6 space-y-6">

    <div class="flex flex-wrap items-center justify-between gap-4">
        <h2 class="text-lg font-bold flex items-center gap-2">
            <i class="fa-solid fa-users text-indigo-500"></i> 成員管理
        </h2>
        
        <div class="flex gap-2">
            <button id="download-btn" onclick="handleDownload()" class="admin-only bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-xl text-sm font-bold hover:bg-gray-50 flex items-center gap-2 transition shadow-sm">
                <i class="fa-solid fa-camera text-rose-500"></i> 下載分析照片
            </button>
            
            <button id="upload-btn" onclick="showUploadModal()" class="admin-only bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-indigo-700 flex items-center gap-2 transition shadow-md">
                <i class="fa-solid fa-plus"></i> 上傳數據
            </button>
        </div>
    </div>

    <div id="admin-summary-section" class="admin-only grid grid-cols-1 md:grid-cols-3 gap-4">
        </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1 space-y-4">
            <div id="children-list" class="space-y-3">
                </div>
        </div>

        <div id="data-display" class="lg:col-span-2 glass-card p-6 min-h-[400px]">
            <div class="flex flex-col items-center justify-center h-full text-gray-400">
                <i class="fa-solid fa-chart-line text-5xl mb-4 opacity-20"></i>
                <p>請從左側選擇成員以查看睡眠分析</p>
            </div>
        </div>
    </div>
</main>

<div id="upload-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex justify-center items-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">上傳 JSON 睡眠數據</h3>
            <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">選擇成員</label>
                <select id="upload-child-select" class="w-full border rounded-lg p-2 bg-gray-50"></select>
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">時區偏置 (小時)</label>
                <input type="number" id="timezone-offset" value="8" class="w-full border rounded-lg p-2 bg-gray-50">
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">貼上 JSON 內容</label>
                <textarea id="json-input" rows="8" class="w-full border rounded-lg p-2 font-mono text-xs bg-gray-50" placeholder='[{"sleepStartTimestampGMT":...}]'></textarea>
            </div>
            <button onclick="submitUpload()" id="submit-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition">開始解析並儲存</button>
        </div>
    </div>
</div>

<script>
    let appData = { children: [], isAdmin: false, userEmail: "chenyyl@gmail.com" }; // Email 應根據實際環境獲取

    window.onload = function() {
        // 初始化載入
        google.script.run
            .withSuccessHandler(onInitSuccess)
            .withFailureHandler(onInitError)
            .loginAndGetChildren(appData.userEmail);
    };

    function onInitSuccess(response) {
        document.getElementById('loader').classList.add('hidden');
        appData.isAdmin = response.isAdmin;
        appData.children = response.children;

        // 顯示登入狀態
        document.getElementById('user-display').innerHTML = `
            <span class="status-badge ${response.isAdmin ? 'bg-rose-100 text-rose-600' : 'bg-green-100 text-green-600'}">
                ${response.isAdmin ? '管理員權限' : '家長帳號'}
            </span>
        `;

        // --- 權限控管：如果是管理員，顯示所有專屬按鈕 ---
        if (response.isAdmin) {
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'flex'; // 顯示按鈕與區塊
            });
            renderAdminStats(response.adminStats);
        }

        renderChildrenList(response.children);
        populateChildSelect(response.children);
    }

    function onInitError(err) {
        alert("系統載入失敗：" + err);
        document.getElementById('loader').innerHTML = `<p class="text-red-500">連線失敗，請重新整理頁面</p>`;
    }

    // 渲染管理員統計摘要
    function renderAdminStats(stats) {
        if (!stats) return;
        const container = document.getElementById('admin-summary-section');
        const latest = stats[0] || { name: '無', lastDate: '-' };
        const totalChildren = stats.length;
        
        container.innerHTML = `
            <div class="glass-card p-4 flex items-center gap-4">
                <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 text-xl"><i class="fa-solid fa-child"></i></div>
                <div><p class="text-xs text-gray-500">成員總數</p><p class="text-xl font-black">${totalChildren}</p></div>
            </div>
            <div class="glass-card p-4 flex items-center gap-4">
                <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center text-amber-600 text-xl"><i class="fa-solid fa-clock-rotate-left"></i></div>
                <div><p class="text-xs text-gray-500">最新更新</p><p class="text-sm font-bold text-gray-700">${latest.name}</p></div>
            </div>
            <div class="glass-card p-4 flex items-center gap-4">
                <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 text-xl"><i class="fa-solid fa-calendar-check"></i></div>
                <div><p class="text-xs text-gray-500">最後更新日</p><p class="text-sm font-bold text-gray-700">${latest.lastDate}</p></div>
            </div>
        `;
    }

    // 渲染左側名單
    function renderChildrenList(children) {
        const list = document.getElementById('children-list');
        list.innerHTML = children.map(child => `
            <div onclick="viewSleepData('${child.id}', '${child.name}')" class="glass-card p-4 cursor-pointer hover:border-indigo-300 hover:shadow-md transition group">
                <div class="flex justify-between items-center">
                    <span class="font-bold group-hover:text-indigo-600">${child.name}</span>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                </div>
            </div>
        `).join('');
    }

    // 查看睡眠數據
    function viewSleepData(id, name) {
        const display = document.getElementById('data-display');
        display.innerHTML = `<div class="flex justify-center py-20"><i class="fa-solid fa-circle-notch fa-spin text-2xl text-indigo-500"></i></div>`;
        
        google.script.run
            .withSuccessHandler(data => {
                const logs = JSON.parse(data);
                if (logs.length === 0) {
                    display.innerHTML = `<div class="text-center py-20 text-gray-400">尚無資料</div>`;
                    return;
                }
                
                let tableHtml = `
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h3 class="text-2xl font-black text-indigo-900">${name}</h3>
                            <p class="text-sm text-gray-500">睡眠紀錄表 (共 ${logs.length} 筆)</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="text-gray-400 border-b italic">
                                    <th class="pb-2 font-medium">日期</th>
                                    <th class="pb-2 font-medium">入睡時間</th>
                                    <th class="pb-2 font-medium">總時數</th>
                                    <th class="pb-2 font-medium">深層/REM</th>
                                    <th class="pb-2 font-medium">起床</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${logs.reverse().map(log => `
                                    <tr class="hover:bg-gray-50 transition">
                                        <td class="py-3 font-bold text-gray-700">${log.date}</td>
                                        <td class="py-3 text-indigo-600">${log.onset}</td>
                                        <td class="py-3 font-black">${log.total}h</td>
                                        <td class="py-3 text-xs text-gray-500">${log.deep}m / ${log.rem}m <br> <span class="text-[10px] text-gray-400">比值: ${log.ratio}</span></td>
                                        <td class="py-3 text-gray-500">${log.wake}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                display.innerHTML = tableHtml;
            })
            .getSleepDataByChildID(id);
    }

    // 下載照片功能
    function handleDownload() {
        if (!appData.isAdmin) return;
        alert("準備生成「" + document.querySelector('#data-display h3')?.innerText + "」的睡眠分析報告照片...");
        // 這裡可以串接 html2canvas
    }

    // Modal 控制
    function showUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); }
    function closeUploadModal() { document.getElementById('upload-modal').classList.add('hidden'); }
    function populateChildSelect(children) {
        const select = document.getElementById('upload-child-select');
        select.innerHTML = children.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    function submitUpload() {
        const btn = document.getElementById('submit-btn');
        const childId = document.getElementById('upload-child-select').value;
        const json = document.getElementById('json-input').value;
        const offset = document.getElementById('timezone-offset').value;
        
        if (!json) { alert("請貼上 JSON 數據"); return; }
        
        btn.disabled = true;
        btn.innerText = "處理中...";
        
        google.script.run
            .withSuccessHandler(res => {
                alert(res);
                btn.disabled = false;
                btn.innerText = "開始解析並儲存";
                closeUploadModal();
                location.reload(); // 重新整理查看結果
            })
            .uploadJsonFromWeb(childId, json, appData.userEmail, offset);
    }
</script>

</body>
</html>
